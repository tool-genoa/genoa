#!/bin/bash
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[1;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

export PATH_BOX=`pwd`

ARCH=$(cat "${PATH_BOX}/SIMU/compilation_arch")
source ${PATH_BOX}/SCRIPTS/arch/${ARCH}

mechanism_low=''
import=""
geckooutdir=""

if [ $# -eq 0 ] 
then
  echo 'argument missing : type --help'
  exit
fi

# Deal with prompt 
while (($# > 0))
do
    case $1 in
        "-h"|"--h"|"--help"|"-help") 
			echo "prepare.sh - Import mechanism from GECKO, Create simulation folder and file to launch a simulation"
            echo "prepare.sh [options]"
            echo "      [ -h | --h | -help | --help ] : this help message"
            echo "      [ --import_mech XXX ] : import mechanism generated by GECKO in the BOXMODEL, XXX argument is the name you want for the mechanism (you must also use --geckooutdir option) "
            echo "      [ --geckooutdir XXX ] : path to the GECKO-A output directory"
            echo ' '
            exit ;;
        "--import_mech")        import=$2      ; shift ; shift ;;
        "--geckooutdir")        geckooutdir=$2 ; shift ; shift ;;
        *) echo "Wrong restart option $1"; exit 1 ;;
    esac
done

if [ -n "$import" ]; then
  if [ -d "${geckooutdir}" ]; then
    
  box=${PATH_BOX}
#  mechanism_low=$(echo "$1" | tr '[:upper:]' '[:lower:]')
  mechanism_low=$(echo "$import" | tr '[:upper:]' '[:lower:]')
  mechanism_maj="${mechanism_low^^}"
  
  [ -e "${geckooutdir}/reactions.dum" ] || echo 'no mechanism in this directory' 
  [ -e "${geckooutdir}/reactions.dum" ] || exit 1
  
  cd ${geckooutdir}
  echo
  echo '--------------------------------'
  echo 'writing files for simulation ...'
  echo '--------------------------------'
  echo 'make the *.mech file'
  cp ${PATH_BOX}/SCRIPTS/makemech.sh ${geckooutdir}
  ./makemech.sh ${mechanism_low}
  rm ./makemech.sh
  
  echo '... cp  dictionary.out *.dict'
  cp dictionary.out ${mechanism_low}.dict
  
  if [ -f pvap.nan.dat ]; then
    echo "... cp pvap.nan.dat ${mechanism_low}.sat"
    cp pvap.nan.dat "${mechanism_low}.sat"
  fi
  
  if [ -f pvap.sim.dat ]; then
    echo "... cp pvap.sim.dat ${mechanism_low}.sat"
    cp pvap.sim.dat "${mechanism_low}.sat"
  fi
  
  if [ -f pvap.myr.dat ]; then
    echo "... cp pvap.myr.dat ${mechanism_low}.sat"
    cp pvap.myr.dat "${mechanism_low}.sat"
  fi
    
  echo ... cp henry_gromhe.dat ${mechanism_low}.hlc
  cp henry_gromhe.dat ${mechanism_low}.hlc
   
  echo ... cp vdiffusion.dat ${mechanism_low}.mdv
  cp vdiffusion.dat ${mechanism_low}.mdv
  
  echo ... cp listprimary.dat ${mechanism_low}.listprimary
  cp listprimary.dat ${mechanism_low}.listprimary
  
  echo ... cp Tg.dat ${mechanism_low}.Tg
  cp Tg.dat ${mechanism_low}.Tg
  
  echo ... cp scheme.log ${mechanism_low}_scheme.log
  cp scheme.log ${mechanism_low}.gecko_log
  
  echo
  echo --------------------------------
  echo searching code name of the input formula
  echo --------------------------------
  [ -e "listprimary.dat" ] || { echo -e "${RED}Error: listprimary.dat not found. Exiting.${NC}"; exit 1; }
  name=$(cut -d" " -f2  listprimary.dat)
  echo $name
  
  echo
  echo --------------------------------
  echo move files .....
  echo --------------------------------
  echo ... mv ${mechanism_low}'.*' $box/'CHEMDAT'
  mv ${mechanism_low}.* $box/'CHEMDAT'
  
  dirsav=$box/'CHEMDAT/COUNTERS/'${mechanism_maj}
  [ -e $dirsav ] && echo 'Directory already exists' || mkdir $dirsav
 
  echo ... cp 'pero*' $box/'CHEMDAT/COUNTERS/'${mechanism_maj}'/'
  cp ./pero* $box/'CHEMDAT/COUNTERS/'${mechanism_maj}'/'
  
  # ---------------------------------------------------------------------
  #----------  NOW in boxmod directory
  # ---------------------------------------------------------------------
  
  echo
  echo ---------------------------------
  echo interpreting ${mechanism_low}.mech
  echo ---------------------------------
  cd $box/'CHEMDAT'
  ./runintp.sh ${mechanism_low} > ${mechanism_low}_interp.out
  cat ${mechanism_low}_interp.out
  
  else
    echo -e "${RED} /!\ geckooutdir is not correct or missing: please check the path ${NC}"
    exit 1
  fi

  cd ${PATH_BOX} 

  if [ -e "CHEMDAT/$mechanism_low.mech" ]; then
    cd SIMU
    mechanism_maj="${mechanism_low^^}"
    if [ -d "$mechanism_maj" ]; then
      echo -e "${YELLOW} ===================================================== ${NC}"
      echo -e "${YELLOW} /!\ Folder SIMU/$mechanism_maj already exists /!\ ${NC}"
      echo -e "${YELLOW} ===================================================== ${NC}"
      exit
    else
      echo -e "${BLUE} ============================================= ${NC}"
      echo -e "${BLUE}    Creating folder in SIMU/${mechanism_maj} ${NC}"
      echo -e "${BLUE} ============================================= ${NC}"
      mkdir -p "$mechanism_maj" || exit 1
      cd $mechanism_maj
      mkdir RESU  || exit 1
      mkdir WORK  || exit 1
      cp ${PATH_BOX}/SCRIPTS/my_param.sh ./
      cp ${PATH_BOX}/SCRIPTS/simu.nml ./
      cp ${PATH_BOX}/SCRIPTS/start.sh ./
      cp ${PATH_BOX}/SCRIPTS/concentrations.init ./
      sed -i "s|_PATH_|${PATH_BOX}|g" my_param.sh
      sed -i s/XXXXX/$mechanism_maj/g start.sh
      sed -i s/xxxxx/$mechanism_low/g start.sh
      
      default_init_conc="5.0E+11"
      awk '{print "REAC G" $1 " " "'$default_init_conc'"}' "${PATH_BOX}/CHEMDAT/$mechanism_low.listprimary" >> concentrations.init
      echo 'END' >> concentrations.init

      echo " >> Simulation folder ${mechanism_maj} successfully created in SIMU/"
      echo " "
      echo -e " /!\ Don't forget to change initial conditions in ${YELLOW}SIMU/${mechanism_maj}/concentrations.init ${NC}"
      echo -e " /!\ Don't forget to change environment parameters in ${YELLOW}SIMU/${mechanism_maj}/simu.nml ${NC}"
      echo -e " /!\ Don't forget to check running parameters (eg number of threads) in ${YELLOW}SIMU/${mechanism_maj}/my_param.sh ${NC}"
      if grep -iq "error" "${PATH_BOX}/CHEMDAT/${mechanism_low}_interp.out"; then
        echo -e "${RED} /!\ ERROR while running the interpreter, check ${YELLOW}CHEMDAT/${mechanism_low}_interp.out ${RED}and ${YELLOW}CHEMDAT/${mechanism_low}.out${RED} and rerun this script after resolving issues.${NC}"
      fi
      echo " "
     
    fi
  else
    echo -e "${RED}  $mechanism_low.mech doesn't exist in CHEMDAT${NC}"
    exit 1
  fi
else
  echo -e "${RED}import_mech argument missing${NC}"
fi
